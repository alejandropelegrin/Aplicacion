<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Priorización de Llamadas de Guardia OVE</title>
  <link rel="icon" type="image/png" href="michelin.png" sizes="32x32">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }

    .tab {
      display: none;
    }

    .resultado {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 1rem;
      padding: 0.4rem 0.6rem;
      border-radius: 5px;
      display: inline-block;
    }

    .badge-ok {
      background-color: #28a745;
      color: #fff;
    }

    .badge-alerta {
      background-color: #dc3545;
      color: #fff;
    }

    .section-header {
      background-color: #007bff;
      color: #fff;
      font-weight: 600;
      padding: 0.5rem;
      border-radius: 5px;
      margin-bottom: 0.5rem;
    }

    .subsection {
      background-color: #f8f9fa;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #007bff;
      border-radius: 5px;
    }

    input[readonly] {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      cursor: not-allowed;
    }

    .card {
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("michelin.png") no-repeat center center;
      background-size: contain;
      opacity: 0.04;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-primary,
    .btn-success,
    .btn-danger {
      min-width: 120px;
    }

    .btn-plano {
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <h1 class="mb-4 text-center">
      <img src="michelin.png" alt="Logo Michelin" style="height:50px; vertical-align:middle; margin-right:10px;">
      Priorización de Llamadas de Guardia OVE
      <img src="michelin.png" alt="Logo Michelin" style="height:50px; vertical-align:middle; margin-right:10px;">
    </h1>

    <h3 class="mb-4 text-center">FSET</h3>

    <!-- Navegacion entre formularios
      El botón FSET no tiene enlace porque es la página actual
      Para agregar más formularios, copiar este bloque y ajustar los enlaces y textos correspondientes
    -->
    <div class="mb-4 text-center">
      <a href="aspeba.html" class="btn btn-primary me-2">ASPEBA</a>
      <a href="zf.html" class="btn btn-primary me-2">ZF</a>
      <a class="btn btn-primary me-2">FSET</a>
      <a href="paletizado.html" class="btn btn-primary me-2">Paletizado</a>
    </div>

    <div class="card p-4 mb-5 shadow">
      <div class="section-header">FSET
        <button class="btn-plano" onclick="descargarPDF()" title="Descargar PDF">💾</button>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Taller:</label>
          <select id="tipo-ove" class="form-select" onchange="mostrarFormulario()">
            <option value="ove1">OVE 1</option>
            <option value="ove2">OVE 2</option>
          </select>
        </div>
      </div>

      <!-- Aqui se añaden las preguntas que se quieren hacer, cada una en su apartado -->
      <!-- FORMULARIO OVE1 -->
      <div id="form-fset-ove1" class="tab">
        <div class="subsection">
          <label class="form-label">Capacidad individual por FSET (Cub/Pasillo)</label>
          <input type="number" class="form-control" value="10.6" readonly>
          <label class="form-label mt-2">N° de FSETs en marcha restantes en el taller</label>
          <input type="number" class="form-control">
          <label class="form-label mt-2">Saturación de FSETs (%)</label>
          <input type="text" class="form-control">
          <label class="form-label mt-2">¿Hay algún código que solo pase por ese FSET?</label>
          <select class="form-select">
            <option value="si">Sí</option>
            <option value="no">No</option>
          </select>
          <!-- Segunda pregunta -->
          <div class="paletizar-group">
            <label class="form-label mt-2">¿Se puede parametrizar el código por otro FSET?</label>
            <select class="form-select">
              <option value="si">Sí</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="resultado badge badge-ok" style="display:none"></div>
        <!-- 🔹 Observaciones después del resultado -->
        <div class="mb-3 mt-3">
          <label class="form-label">Observaciones FSET:</label>
          <textarea id="obs-fset-ove1" class="form-control" rows="3"
            placeholder="Observaciones del formulario FSET OVE1"></textarea>
        </div>
      </div>

      <!-- FORMULARIO OVE2 -->
      <div id="form-fset-ove2" class="tab">
        <div class="subsection">
          <label class="form-label">Capacidad individual por FSET (Cub/Pasillo)</label>
          <input type="number" class="form-control" value="10" readonly>
          <label class="form-label mt-2">N° de FSETs en marcha restantes en el taller</label>
          <input type="number" class="form-control">
          <label class="form-label mt-2">Saturación de FSETs (%)</label>
          <input type="text" class="form-control">
          <label class="form-label mt-2">¿Hay algún código que solo pase por ese FSET?</label>
          <select class="form-select">
            <option value="si">Sí</option>
            <option value="no">No</option>
          </select>
          <!-- Segunda pregunta -->
          <div class="paletizar-group">
            <label class="form-label mt-2">¿Se puede parametrizar el código por otro FSET?</label>
            <select class="form-select">
              <option value="si">Sí</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="resultado badge badge-ok" style="display:none"></div>
        <!-- Observaciones después del resultado -->
        <div class="mb-3 mt-3">
          <label class="form-label">Observaciones FSET:</label>
          <textarea id="obs-fset-ove2" class="form-control" rows="3"
            placeholder="Observaciones del formulario FSET OVE2"></textarea>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-3" style="color: #555; font-size: 0.9rem;">
    Sistema de Priorización OVE - Michelin © <span id="anio-footer"></span>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Mostrar el formulario según el taller seleccionado
    function mostrarFormulario() {
      const ove = document.getElementById("tipo-ove").value;
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      document.getElementById(`form-fset-${ove}`).style.display = 'block';
      evaluarGuardia();
    }

    // Evaluar si llamar a guardia según las respuestas
    function evaluarGuardia() {
      const forms = [
        { id: "form-fset-ove1", minNum: 6, minSat: 80 },
        { id: "form-fset-ove2", minNum: 5, minSat: 80 }
      ];

      forms.forEach(f => {
        const div = document.getElementById(f.id);
        if (div.style.display !== "block") return;

        const inputs = div.querySelectorAll("input");
        const selects = div.querySelectorAll("select");

        const num = inputs[1].value;
        const sat = inputs[2].value;
        const codigoSolo = selects[0]; // primer select
        const paletizarGroup = div.querySelector(".paletizar-group");
        const paletizar = paletizarGroup.querySelector("select");

        // Mostrar u ocultar la segunda pregunta según la primera
        if (codigoSolo.value === "no") {
          paletizarGroup.style.display = "none";
          paletizar.value = "si"; // reset por defecto
        } else {
          paletizarGroup.style.display = "block";
        }

        // Evaluación de Llamar Guardia
        if (num && sat && codigoSolo.value) {
          const llamar = (parseInt(num) < f.minNum) || (parseFloat(sat) < f.minSat) || (codigoSolo.value === "si" && paletizar.value === "no");
          mostrarBadge(div, llamar);
        } else {
          const badge = div.querySelector(".resultado");
          if (badge) badge.style.display = "none";
        }
      });
    }

    // Función para mostrar el badge de resultado (llamar guardia o ok)
    function mostrarBadge(div, llamar) {
      let badge = div.querySelector(".resultado");
      if (!badge) {
        badge = document.createElement("div");
        badge.classList.add("resultado", "badge");
        div.appendChild(badge);
      }
      badge.style.display = "inline-block";
      badge.innerText = llamar ? "⚠ Llamar Guardia" : "OK";
      badge.className = "resultado badge " + (llamar ? "badge-alerta" : "badge-ok");
    }

    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', evaluarGuardia);
      el.addEventListener('change', evaluarGuardia);
    });

    window.onload = function () {
      document.getElementById("anio-footer").textContent = new Date().getFullYear();
      mostrarFormulario();
    }

    // Función para descargar el PDF con los datos del formulario actual
    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const pageWidth = 210;
      const margin = 10;
      const tableWidth = pageWidth - 2 * margin;
      const lineHeight = 6;
      let y = 35;

      // --- ENCABEZADO ---
      doc.setFontSize(18);
      doc.setTextColor(0, 51, 153);
      doc.text("Priorización de Llamadas Guardia OVE - FSET", margin, 20);
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Generado: ${new Date().toLocaleString()}`, pageWidth - margin, 20, { align: "right" });
      doc.line(margin, 25, pageWidth - margin, 25);

      // --- FORMULARIO ACTUAL ---
      const oveSelect = document.getElementById("tipo-ove");
      const ove = oveSelect.value.toUpperCase();
      const form = document.getElementById(`form-fset-${ove.toLowerCase()}`);
      const obs = document.getElementById(`obs-fset-${ove.toLowerCase()}`)?.value || "";

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text(`Formulario FSET - ${ove}`, margin, y);
      y += 6;

      // --- Cabecera de tabla ---
      doc.setFontSize(11);
      doc.setFillColor(0, 123, 255);
      doc.setTextColor(255, 255, 255);
      doc.rect(margin, y, tableWidth, lineHeight, 'F');
      doc.rect(margin, y, tableWidth, lineHeight);
      doc.text("Campo", margin + 2, y + 4.5);
      doc.text("Valor", margin + tableWidth - 45, y + 4.5);
      y += lineHeight;

      // --- Campos ---
      const fields = [{ label: "Taller", value: ove }];

      const allFields = form.querySelectorAll(".subsection > label, .subsection > input, .subsection > select, .subsection > div.paletizar-group select");
      let skipSecondQuestion = false;

      allFields.forEach(el => {
        let label = "";
        let value = "";

        if (el.tagName.toLowerCase() === "label") {
          label = el.innerText.trim();
          return; // seguimos al siguiente, el label se asocia al siguiente input/select
        }

        if (el.tagName.toLowerCase() === "input" || el.tagName.toLowerCase() === "select") {
          const prevLabel = el.previousElementSibling;
          label = prevLabel?.tagName.toLowerCase() === "label" ? prevLabel.innerText.trim() : "Campo";
          value = el.value || "—";

          // Si es la primera pregunta y la respuesta es "no", saltamos la segunda
          if (label.includes("código que solo pase") && value.toLowerCase() === "no") {
            skipSecondQuestion = true;
          }

          // Omitir segunda pregunta si skipSecondQuestion es true
          if (label.includes("parametrizar") && skipSecondQuestion) return;

          fields.push({ label, value });
        }
      });

      // --- Dibujar tabla ---
      fields.forEach((f, index) => {
        doc.setFillColor(index % 2 === 0 ? 240 : 255);
        doc.rect(margin, y, tableWidth, lineHeight, 'F');
        doc.rect(margin, y, tableWidth, lineHeight);

        const linesLabel = doc.splitTextToSize(f.label, tableWidth - 50);
        const linesValor = doc.splitTextToSize(f.value, 40);
        const maxLines = Math.max(linesLabel.length, linesValor.length);

        for (let i = 0; i < maxLines; i++) {
          doc.setTextColor(0, 0, 0);
          doc.text(linesLabel[i] || '', margin + 2, y + 4 + i * 5);
          doc.text(linesValor[i] || '', margin + tableWidth - 45, y + 4 + i * 5);
        }

        y += lineHeight * maxLines;
        if (y > 260) { doc.addPage(); y = 20; }
      });

      y += 10;

      // --- RESULTADO ---
      const resText = form.querySelector(".resultado")?.innerText || "—";
      let color = [40, 167, 69];
      if (resText.toLowerCase().includes("llamar")) color = [220, 53, 69];
      else if (resText.toLowerCase().includes("valorar")) color = [255, 193, 7];

      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text("Resultado FSET:", margin, y);
      doc.setTextColor(...color);
      doc.text(resText, margin + 50, y);
      y += 10;

      // --- OBSERVACIONES ---
      if (obs.trim()) {
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text("Observaciones:", margin, y);
        y += 6;
        const linesObs = doc.splitTextToSize(obs, tableWidth);
        linesObs.forEach(line => {
          if (y > 275) { doc.addPage(); y = 20; }
          doc.text(line, margin, y);
          y += 6;
        });
        y += 6;
      }

      // --- PIE DE PÁGINA ---
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`Sistema de Priorización OVE - Michelin © ${new Date().getFullYear()}`, pageWidth / 2, 285, { align: "center" });

      // --- GUARDADO ---
      const nombreArchivo = `Priorizacion_Guardia_FSET_${new Date().toISOString().slice(0, 10)}.pdf`;
      if ('showSaveFilePicker' in window) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: nombreArchivo,
            startIn: 'documents',
            types: [{ description: 'PDF', accept: { 'application/pdf': ['.pdf'] } }]
          });
          if (!handle) return;
          const writable = await handle.createWritable();
          await writable.write(await doc.output("blob"));
          await writable.close();
          alert("PDF guardado correctamente");
        } catch (err) {
          if (err.name === "AbortError") return;
          console.error("Error al guardar PDF:", err);
        }
      } else {
        doc.save(nombreArchivo);
      }
    }

  </script>
</body>

</html>